<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ứng dụng Ghi âm</title>
    <link rel="stylesheet" href="/index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script type="importmap">
      {
        "imports": {
          "@google/genai": "https://esm.sh/@google/genai@^0.8.0",
          "marked": "https://esm.sh/marked@^4.0.0",
          "docx": "https://esm.sh/docx@8.5.0"
        }
      }
    </script>
  </head>
  <body>
    <div class="app-container">
      <div class="main-content">
        <div class="note-area">
          <div class="note-header">
            <div class="editor-title" contenteditable="true" placeholder="Ghi chép chưa có tiêu đề">
              Ghi chép chưa có tiêu đề
            </div>
            <div class="header-actions">
              <div class="tab-navigation-container">
                <div class="tab-navigation">
                  <button class="tab-button active" data-tab="note">Ghi chép đã trau chuốt</button>
                  <button class="tab-button" data-tab="raw">Ghi chép nguyên văn</button>
                  <div class="active-tab-indicator"></div>
                </div>
              </div>
              <button class="action-button" id="historyButton" title="Lịch sử ghi chép">
                <i class="fas fa-history"></i>
              </button>
              <button class="action-button" id="downloadButton" title="Tải xuống tất cả ghi chép (DOCX, cũ nhất trước tiên)">
                <i class="fas fa-download"></i>
              </button>
            </div>
          </div>

          <div class="note-content-wrapper">
            <div
              id="polishedNote"
              class="note-content active"
              contenteditable="true"
              placeholder="Ghi chép đã trau chuốt của bạn sẽ xuất hiện ở đây..."
            ></div>
            <div
              id="rawTranscription"
              class="note-content"
              contenteditable="true"
              placeholder="Ghi chép nguyên văn sẽ xuất hiện ở đây..."
            ></div>
          </div>
        </div>

        <div class="recording-interface">
          <div id="liveRecordingTitle" class="live-recording-title" style="display: none">
            Đang ghi âm
          </div>
          <canvas id="liveWaveformCanvas" style="display: none"></canvas>
          <div id="liveRecordingTimerDisplay" class="live-recording-timer" style="display: none">
            00:00.00
          </div>

          <div class="status-indicator">
            <span id="recordingStatus" class="status-text">Sẵn sàng ghi âm</span>
          </div>

          <div class="recording-controls">
            <button class="action-button" id="guideButton" title="Hướng dẫn">
              <i class="fas fa-question-circle"></i>
            </button>
            <button id="recordButton" class="record-button" title="Bắt đầu/Dừng ghi âm">
              <div class="record-button-inner">
                <i class="fas fa-microphone"></i>
              </div>
              <svg class="record-waves" viewBox="0 0 200 200">
                <circle class="wave wave1" cx="100" cy="100" r="40" />
                <circle class="wave wave2" cx="100" cy="100" r="70" />
                <circle class="wave wave3" cx="100" cy="100" r="100" />
              </svg>
              <span class="record-text">Ghi âm</span>
            </button>
            <button class="action-button" id="aiChatButton" title="Trò chuyện với AI">
                <i class="fas fa-robot"></i>
            </button>
          </div>
        </div>
      </div>
      <footer class="app-footer">
        <p>AI được phát triển bởi: Đỗ Như Lâm - Giám đốc Đào tạo</p>
        <p><a href="https://abaii.vn/" target="_blank" rel="noopener noreferrer">Viện Công nghệ Blockchain và Trí tuệ nhân tạo ABAII</a></p>
      </footer>
    </div>

    <div id="historyModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lịch sử Ghi chép</h2>
                <button id="closeHistoryModal" class="close-button" title="Đóng">&times;</button>
            </div>
            <ul id="historyList" class="modal-body">
                <!-- History items will be populated by script -->
            </ul>
        </div>
    </div>

    <div id="guideModal" class="modal-overlay hidden">
      <div class="modal-content">
          <div class="modal-header">
              <h2>Hướng dẫn Sử dụng</h2>
              <button id="closeGuideModal" class="close-button" title="Đóng">&times;</button>
          </div>
          <div class="modal-body guide-body">
              <ul>
                  <li class="guide-item">
                      <i class="fas fa-microphone-alt"></i>
                      <div class="guide-item-content">
                          <h3>Bắt đầu & Dừng Ghi âm</h3>
                          <p>Nhấn nút micro lớn để bắt đầu. Nhấn lại nút dừng màu đỏ để kết thúc. Ghi chép sẽ được xử lý tự động.</p>
                      </div>
                  </li>
                  <li class="guide-item">
                      <i class="fas fa-history"></i>
                      <div class="guide-item-content">
                          <h3>Xem Lịch sử</h3>
                          <p>Nhấn vào biểu tượng đồng hồ để xem, tải lại hoặc xóa các ghi chép đã lưu trước đây.</p>
                      </div>
                  </li>
                  <li class="guide-item">
                      <i class="fas fa-robot"></i>
                      <div class="guide-item-content">
                          <h3>Trò chuyện với AI</h3>
                          <p>Nhấn vào biểu tượng robot để bắt đầu cuộc trò chuyện với AI. AI có thể trả lời các câu hỏi dựa trên nội dung các ghi chép của bạn.</p>
                      </div>
                  </li>
                  <li class="guide-item">
                      <i class="fas fa-file-word"></i>
                      <div class="guide-item-content">
                          <h3>Tải xuống Tất cả</h3>
                          <p>Nhấn vào biểu tượng tải xuống để lưu tất cả các ghi chép (hiện tại và trong lịch sử) vào một tệp DOCX duy nhất.</p>
                      </div>
                  </li>
                   <li class="guide-item">
                      <i class="fas fa-pencil-alt"></i>
                      <div class="guide-item-content">
                          <h3>Chỉnh sửa Trực tiếp</h3>
                          <p>Bạn có thể nhấp và chỉnh sửa tiêu đề, ghi chép đã trau chuốt hoặc ghi chép nguyên văn. Các thay đổi được lưu tự động.</p>
                      </div>
                  </li>
              </ul>
              <hr class="guide-separator">
              <div class="guide-section">
                  <h3>GIỚI THIỆU TRỢ LÝ AI TỐC KÝ ÂM THANH</h3>
                  <h4>Chức năng:</h4>
                  <p>Trợ lý AI sử dụng công nghệ nhận dạng giọng nói tiên tiến nhất hiện nay để hỗ trợ ghi chép tốc ký trong các cuộc họp, hội nghị, hội thảo, buổi làm việc, nói chuyện.... Hệ thống chuyển lời nói thành văn bản tiếng Việt để người dùng sử dụng làm biên bản hoặc tài liệu khác. Khi người nói giao tiếp bằng bất cứ ngoại ngữ nào, nội dung vẫn được chuyển sang tiếng Việt.</p>
                  <h4>Bảo mật:</h4>
                  <p>Các ghi chép âm thanh, chuyển dữ liệu thành văn bản đều lưu trữ trên máy tính cá nhân của người dùng. Dữ liệu không bị chia sẻ hoặc lưu trữ ngoài máy tính cá nhân của người dùng.</p>
                  <h4>Lưu trữ:</h4>
                  <p>Kết quả được xuất dưới dạng tệp .docx để người dùng chủ động lưu giữ. Dữ liệu tạm thời chỉ tồn tại trong không gian lưu trữ cá nhân. Trợ lý không sử dụng dữ liệu để huấn luyện mô hình AI.</p>
              </div>
          </div>
      </div>
    </div>
    
    <div id="aiChatModal" class="modal-overlay hidden">
        <div class="modal-content chat-modal">
            <div class="modal-header">
                <h2>Trò chuyện với AI</h2>
                <button id="closeAiChatModal" class="close-button" title="Đóng">&times;</button>
            </div>
            <div id="chatMessages" class="modal-body chat-messages-body">
                <!-- Chat messages will be populated by script -->
            </div>
            <div class="chat-input-area">
                <div id="attachmentPreviewContainer" class="attachment-preview-container"></div>
                <div class="chat-input-bar">
                    <button id="attachFileButton" class="chat-tool-button" title="Đính kèm tệp"><i class="fas fa-paperclip"></i></button>
                    <button id="voiceInputButton" class="chat-tool-button" title="Nhập bằng giọng nói"><i class="fas fa-microphone"></i></button>
                    <input type="text" id="chatInput" placeholder="Hỏi AI về ghi chép của bạn..." autocomplete="off">
                    <button id="sendChatButton" title="Gửi"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" class="hidden" accept="image/*,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
    <div id="micStatus" class="debug-panel"></div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const tabNav = document.querySelector(".tab-navigation");
        const tabButtons = tabNav.querySelectorAll(".tab-button");
        const activeTabIndicator = tabNav.querySelector(".active-tab-indicator");
        const noteContents = document.querySelectorAll(".note-content");

        function setActiveTab(activeButton, skipAnimation = false) {
          if (!activeButton || !activeTabIndicator) return;

          tabButtons.forEach((btn) => btn.classList.remove("active"));
          activeButton.classList.add("active");

          const tabName = activeButton.getAttribute("data-tab");
          noteContents.forEach((content) => content.classList.remove("active"));

          if (tabName === "raw") {
            document.getElementById("rawTranscription").classList.add("active");
          } else {
            document.getElementById("polishedNote").classList.add("active");
          }

          const originalTransition = activeTabIndicator.style.transition;
          if (skipAnimation) {
            activeTabIndicator.style.transition = "none";
          } else {
            activeTabIndicator.style.transition = "";
          }

          activeTabIndicator.style.left = `${activeButton.offsetLeft}px`;
          activeTabIndicator.style.width = `${activeButton.offsetWidth}px`;

          if (skipAnimation) {
            activeTabIndicator.offsetHeight;
            activeTabIndicator.style.transition = originalTransition;
          }
        }

        tabButtons.forEach((button) => {
          button.addEventListener("click", (e) => {
            setActiveTab(e.currentTarget);
          });
        });

        const initiallyActiveButton = tabNav.querySelector(".tab-button.active");
        if (initiallyActiveButton) {
          requestAnimationFrame(() => {
            setActiveTab(initiallyActiveButton, true);
          });
        }

        window.addEventListener("resize", () => {
          requestAnimationFrame(() => {
            const currentActiveButton = tabNav.querySelector(".tab-button.active");
            if (currentActiveButton) {
              setActiveTab(currentActiveButton, true);
            }
          });
        });
      });
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>